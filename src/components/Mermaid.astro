---
// src/components/Mermaid.astro
// å®Œæ•´äº¤äº’ç‰ˆï¼šä¸»ç•Œé¢æ»šåŠ¨æ¡ + Ctrlç¼©æ”¾(zoom) + åŒå‡»å…¨å±
// å…¨å±ï¼šæ‹–æ‹½å¹³ç§» + Ctrlç¼©æ”¾(transform)
---

<script>
  import mermaid from "mermaid";

  const isDark = document.documentElement.classList.contains("dark");
  console.log("isDark =", isDark);

  const BASE_FONT = 11;

  mermaid.initialize({
    startOnLoad: false,
    theme: isDark ? "dark" : "default",
    securityLevel: "loose",

    // âœ… Mermaid v10+ ç±»å‹ä¸å…è®¸ç›´æ¥å†™ flowchart.fontSize / sequence.fontSize ç­‰
    // âœ… ç»Ÿä¸€é€šè¿‡ themeVariables + CSS å¼ºåˆ¶å­—ä½“å¤§å°æ›´ç¨³å®š
    themeVariables: {
      fontSize: `${BASE_FONT}px`,
      fontFamily: "Arial, sans-serif",
    },
  });

  function logMermaidAllLabels(): void {
    document.querySelectorAll<SVGSVGElement>(".mermaid svg").forEach((svg, svgIndex) => {
      console.log(`====== [SVG ${svgIndex}] ======`);

      // 1) æ™®é€š svg text
      svg.querySelectorAll<SVGTextElement>("text").forEach((node, i) => {
        const style = getComputedStyle(node);
        console.log(
          `[text ${i}]`,
          node.textContent?.trim(),
          "font-size:",
          style.fontSize,
          "font-family:",
          style.fontFamily
        );
      });

      // 2) foreignObject (HTML label)
      svg.querySelectorAll<SVGForeignObjectElement>("foreignObject").forEach((fo, i) => {
        const div = fo.querySelector<HTMLElement>("div, span, p") || (fo as unknown as HTMLElement);
        const style = getComputedStyle(div);
        console.log(
          `[foreignObject ${i}]`,
          div.textContent?.trim(),
          "font-size:",
          style.fontSize,
          "font-family:",
          style.fontFamily
        );
      });
    });
  }

  function forceSvgOverflow(div: HTMLElement): void {
    const wrapper = div.querySelector<HTMLElement>(".mermaid-interactive-wrapper");
    const svg = div.querySelector<SVGSVGElement>(".mermaid-interactive-wrapper svg");
    if (!wrapper || !svg) return;

    // âœ… æ°¸è¿œä¸è¦è®© svg è‡ªåŠ¨ fit å®¹å™¨
    svg.style.width = "auto";
    svg.style.maxWidth = "none";
    svg.style.height = "auto";
    svg.style.display = "block";

    requestAnimationFrame(() => {
      const wrapperWidth = wrapper.clientWidth;

      // âœ… ä¼˜å…ˆä½¿ç”¨ viewBoxï¼Œæ›´ç¨³å®šï¼ˆç‰¹åˆ«æ˜¯ ganttï¼‰
      const vb = svg.viewBox?.baseVal;
      const viewBoxWidth = vb?.width || 0;

      // fallbackï¼šbbox
      const bboxWidth = svg.getBBox().width || 0;

      const realWidth = Math.ceil((viewBoxWidth || bboxWidth) + 40);

      // âœ… ç”¨çœŸå®å®½åº¦æ’‘å¼€ svg
      svg.style.width = `${realWidth}px`;

      // âœ… è¶…å‡ºæ‰æ»šåŠ¨
      if (realWidth > wrapperWidth) {
        wrapper.classList.add("has-scroll");
      } else {
        wrapper.classList.remove("has-scroll");
      }

      console.log(
        "[forceSvgOverflow]",
        "wrapperWidth=",
        wrapperWidth,
        "realWidth=",
        realWidth,
        "viewBoxWidth=",
        viewBoxWidth,
        "bboxWidth=",
        bboxWidth
      );
    });
  }

  function extractMermaidText(container: Element): string {
    const code = container.querySelector<HTMLElement>("code");
    if (code) {
      const text = (code.innerText || code.textContent || "").trim();
      return cleanMermaidText(text);
    }

    const linesNodeList = container.querySelectorAll<HTMLElement>('[class*="line"]:not([class*="number"])');
    if (linesNodeList.length > 0) {
      const lines = Array.from(linesNodeList) as HTMLElement[];
      const text = lines
        .map((lineEl) => {
          const clone = lineEl.cloneNode(true) as HTMLElement;
          clone
            .querySelectorAll<HTMLElement>('[class*="number"], .line-number, .ln')
            .forEach((el) => el.remove());
          return (clone.innerText || clone.textContent || "").trim();
        })
        .filter((line) => line.length > 0)
        .join("\n");

      return cleanMermaidText(text);
    }

    const text = ((container as HTMLElement).innerText || container.textContent || "").trim();
    return cleanMermaidText(text);
  }

  function cleanMermaidText(text: string): string {
    const lines = text.split("\n");
    const cleanedLines: string[] = [];

    for (let line of lines) {
      line = line.trim();
      if (/^\d+$/.test(line)) continue;
      line = line.replace(/^\d+\s+/, "");
      if (line.length > 0) cleanedLines.push(line);
    }

    const result = cleanedLines.join("\n").trim();
    console.log("[Mermaid] After cleaning:", result);
    return result;
  }

  function findMermaidBlocks(): Element[] {
    const results: Element[] = [];

    document.querySelectorAll("pre").forEach((pre) => {
      const code = pre.querySelector("code");
      const cls = (code?.className || pre.className || "").toLowerCase();
      if (cls.includes("mermaid")) {
        results.push(pre);
      }
    });

    document.querySelectorAll("figure, div.expressive-code, [class*='astro-code']").forEach((box) => {
      const hasMermaidLabel = Array.from(box.querySelectorAll("*")).some((n) => {
        const text = (n.textContent || "").trim().toUpperCase();
        return text === "MERMAID";
      });

      if (hasMermaidLabel) {
        results.push(box);
      }
    });

    document.querySelectorAll<HTMLElement>('[data-language="mermaid"]').forEach((el) => {
      const container = el.closest("figure, div, pre") || el;
      results.push(container);
    });

    return Array.from(new Set(results));
  }

  // åˆ›å»ºæ¨¡æ€æ¡†
  function createModal(): void {
    if (document.getElementById("mermaid-modal")) return;

    const modal = document.createElement("div");
    modal.id = "mermaid-modal";
    modal.className = "mermaid-modal";
    modal.innerHTML = `
      <div class="mermaid-modal-overlay"></div>
      <div class="mermaid-modal-content">
        <button class="mermaid-modal-close" aria-label="å…³é—­">Ã—</button>
        <div class="mermaid-modal-controls">
          <button class="mermaid-zoom-btn" data-action="zoom-in" title="æ”¾å¤§">ğŸ”+</button>
          <button class="mermaid-zoom-btn" data-action="zoom-out" title="ç¼©å°">ğŸ”-</button>
          <button class="mermaid-zoom-btn" data-action="reset" title="é‡ç½®">â†º</button>
          <span class="mermaid-zoom-level">100%</span>
        </div>
        <div class="mermaid-modal-body"></div>
      </div>
    `;
    document.body.appendChild(modal);

    const closeBtn = modal.querySelector<HTMLButtonElement>(".mermaid-modal-close");
    const overlay = modal.querySelector<HTMLElement>(".mermaid-modal-overlay");

    const closeModal = () => {
      modal.classList.remove("active");
      document.body.style.overflow = "";
    };

    closeBtn?.addEventListener("click", closeModal);
    overlay?.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "Escape" && modal.classList.contains("active")) {
        closeModal();
      }
    });
  }

  // æ›´æ–°ç¼©æ”¾æ¯”ä¾‹æ˜¾ç¤º
  function updateZoomDisplay(container: HTMLElement, scale: number): void {
    const zoomLevel = container.closest(".mermaid-modal")?.querySelector<HTMLElement>(".mermaid-zoom-level");
    if (zoomLevel) {
      zoomLevel.textContent = `${Math.round(scale * 100)}%`;
    }
  }

  // âœ… ä¸»ç•Œé¢æ»šåŠ¨æ¡ç¼©æ”¾ï¼ˆä½¿ç”¨ zoomï¼Œä¿è¯ overflow-x ç”Ÿæ•ˆï¼‰
  function makeScrollableZoom(wrapper: HTMLElement, content: HTMLElement): void {
    let scale = 1;

    const applyZoom = () => {
      scale = Math.min(Math.max(scale, 0.5), 3); // âœ… ä¸»ç•Œé¢ç¼©æ”¾èŒƒå›´
      (content.style as any).zoom = String(scale); // zoom ä¸æ˜¯æ ‡å‡†å±æ€§ï¼ŒTS å¯èƒ½ä¸è®¤è¯†
      console.log("zoom =", (content.style as any).zoom);
    };

    wrapper.addEventListener(
      "wheel",
      (e: WheelEvent) => {
        if (!e.ctrlKey && !e.metaKey) return;
        e.preventDefault();

        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale += delta;
        applyZoom();
      },
      { passive: false }
    );

    applyZoom();
  }

  type TransformController = {
    get scale(): number;
    set scale(v: number);

    get translateX(): number;
    set translateX(v: number);

    get translateY(): number;
    set translateY(v: number);

    applyTransform: () => void;
  };

  // âœ… å…¨å±äº¤äº’ï¼šæ‹–æ‹½ + transform ç¼©æ”¾ï¼ˆä¿è¯æ°¸è¿œè¿”å› TransformControllerï¼‰
  function makeInteractive(wrapper: HTMLElement, options = { enableDrag: true }): TransformController {
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let lastTranslateX = 0;
    let lastTranslateY = 0;

    const svg = wrapper.querySelector<SVGSVGElement>("svg");

    const applyTransform = () => {
      if (!svg) return;
      svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      svg.style.transformOrigin = "0 0";
      svg.style.transition = isDragging ? "none" : "transform 0.15s ease";
    };

    // âœ… å¦‚æœæ²¡ SVGï¼Œä¹Ÿè¿”å›ä¸€ä¸ªç©º controllerï¼Œé¿å… transform å˜ undefined
    if (!svg) {
      return {
        get scale() {
          return scale;
        },
        set scale(v: number) {
          scale = v;
        },
        get translateX() {
          return translateX;
        },
        set translateX(v: number) {
          translateX = v;
        },
        get translateY() {
          return translateY;
        },
        set translateY(v: number) {
          translateY = v;
        },
        applyTransform,
      };
    }

    // âœ… æ‹–æ‹½ï¼ˆå¯é€‰ï¼‰
    if (options.enableDrag) {
      wrapper.addEventListener("mousedown", (e: MouseEvent) => {
        if (e.button !== 0) return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        lastTranslateX = translateX;
        lastTranslateY = translateY;
        wrapper.style.cursor = "grabbing";
        e.preventDefault();
      });

      document.addEventListener("mousemove", (e: MouseEvent) => {
        if (!isDragging) return;

        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;

        translateX = lastTranslateX + deltaX;
        translateY = lastTranslateY + deltaY;

        applyTransform();
      });

      document.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          wrapper.style.cursor = "grab";
        }
      });
    }

    // Ctrl + æ»šè½®ç¼©æ”¾ï¼ˆå…¨å±ï¼‰
    wrapper.addEventListener(
      "wheel",
      (e: WheelEvent) => {
        if (!e.ctrlKey && !e.metaKey) return;

        e.preventDefault();

        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        const newScale = Math.min(Math.max(0.3, scale + delta), 5);

        // ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
        const rect = wrapper.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const scaleChange = newScale / scale;
        translateX = mouseX - (mouseX - translateX) * scaleChange;
        translateY = mouseY - (mouseY - translateY) * scaleChange;

        scale = newScale;
        applyTransform();

        updateZoomDisplay(wrapper, scale);
      },
      { passive: false }
    );

    wrapper.style.cursor = options.enableDrag ? "grab" : "default";
    wrapper.style.overflow = "hidden";
    applyTransform();

    return {
      get scale() {
        return scale;
      },
      set scale(v: number) {
        scale = v;
      },
      get translateX() {
        return translateX;
      },
      set translateX(v: number) {
        translateX = v;
      },
      get translateY() {
        return translateY;
      },
      set translateY(v: number) {
        translateY = v;
      },
      applyTransform,
    };
  }

  // ä¸ºæ™®é€šè§†å›¾æ·»åŠ äº¤äº’
  function addInteractiveFeature(mermaidDiv: HTMLElement): void {
    const wrapper = document.createElement("div");
    wrapper.className = "mermaid-interactive-wrapper";

    const content = document.createElement("div");
    content.className = "mermaid-interactive-content";

    content.innerHTML = mermaidDiv.innerHTML;
    mermaidDiv.innerHTML = "";

    wrapper.appendChild(content);
    mermaidDiv.appendChild(wrapper);

    const hint = document.createElement("div");
    hint.className = "mermaid-hint";
    // hint.innerHTML = `<strong>æç¤ºï¼š</strong> ä¸»ç•Œé¢ Ctrl/âŒ˜ + æ»šè½®ç¼©æ”¾ï¼›åŒå‡»è¿›å…¥å…¨å±ï¼›å…¨å±å¯æ‹–æ‹½å¹³ç§» + Ctrl/âŒ˜ ç¼©æ”¾`;
    mermaidDiv.appendChild(hint);

    // âœ… ä¸»ç•Œé¢ï¼šæ»šåŠ¨æ¡ç¼©æ”¾ï¼ˆzoomï¼‰
    makeScrollableZoom(wrapper, content);

    // åŒå‡»å…¨å±
    content.addEventListener("dblclick", () => {
      openFullscreen(mermaidDiv);
    });
  }

  // æ‰“å¼€å…¨å±æ¨¡æ€æ¡†
  function openFullscreen(mermaidDiv: HTMLElement): void {
    const modal = document.getElementById("mermaid-modal");
    const modalBody = modal?.querySelector<HTMLElement>(".mermaid-modal-body");

    if (!modal || !modalBody) return;

    const svg = mermaidDiv.querySelector<SVGSVGElement>("svg");
    if (!svg) return;

    // å…‹éš† SVG åˆ°æ¨¡æ€æ¡†
    const clonedSvg = svg.cloneNode(true) as SVGSVGElement;
    modalBody.innerHTML = "";
    modalBody.appendChild(clonedSvg);

    const transform = makeInteractive(modalBody, { enableDrag: true });

    const zoomIn = modal.querySelector<HTMLButtonElement>('[data-action="zoom-in"]');
    const zoomOut = modal.querySelector<HTMLButtonElement>('[data-action="zoom-out"]');
    const reset = modal.querySelector<HTMLButtonElement>('[data-action="reset"]');

    zoomIn?.addEventListener("click", () => {
      const newScale = Math.min(transform.scale + 0.2, 5);
      transform.scale = newScale;
      transform.applyTransform();
      updateZoomDisplay(modalBody, newScale);
    });

    zoomOut?.addEventListener("click", () => {
      const newScale = Math.max(transform.scale - 0.2, 0.3);
      transform.scale = newScale;
      transform.applyTransform();
      updateZoomDisplay(modalBody, newScale);
    });

    reset?.addEventListener("click", () => {
      transform.scale = 1;
      transform.translateX = 0;
      transform.translateY = 0;
      transform.applyTransform();
      updateZoomDisplay(modalBody, 1);
    });

    modal.classList.add("active");
    document.body.style.overflow = "hidden";
    updateZoomDisplay(modalBody, 1);
  }

  async function renderMermaid(): Promise<void> {
    const blocks = findMermaidBlocks();
    console.log("[Mermaid] Found blocks:", blocks.length);

    let converted = 0;

    for (const container of blocks) {
      try {
        const text = extractMermaidText(container);

        const isMermaid =
          text.includes("graph") ||
          text.includes("sequenceDiagram") ||
          text.includes("classDiagram") ||
          text.includes("stateDiagram") ||
          text.includes("erDiagram") ||
          text.includes("journey") ||
          text.includes("gantt") ||
          text.includes("pie") ||
          text.includes("flowchart");

        if (!isMermaid) continue;

        const div = document.createElement("div");
        div.className = "mermaid mermaid-container";
        div.textContent = text;

        container.replaceWith(div);
        converted++;
      } catch (e) {
        console.error("[Mermaid] Error processing block:", e);
      }
    }

    console.log("[Mermaid] Converted:", converted);

    if (converted > 0) {
      try {
        await mermaid.run({ querySelector: ".mermaid" });
        logMermaidAllLabels();
        console.log("[Mermaid] Rendered âœ…");

        createModal();

        document.querySelectorAll<HTMLElement>(".mermaid-container").forEach((div) => {
          if (!div.querySelector(".mermaid-interactive-wrapper")) {
            addInteractiveFeature(div);
          }

          // âœ… å¼ºåˆ¶è®© SVG äº§ç”Ÿæº¢å‡º -> æ¨ªå‘æ»šåŠ¨æ¡å¿…å‡ºç°
          forceSvgOverflow(div);
        });
      } catch (e) {
        console.error("[Mermaid] Render failed âŒ", e);
      }
    }
  }

  // åˆå§‹æ¸²æŸ“
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      renderMermaid();
    });
  } else {
    renderMermaid();
  }

  // Swup æ”¯æŒï¼ˆwindow.swup ä¸æ˜¯æ ‡å‡†ç±»å‹ï¼‰
  const w = window as any;
  if (w.swup) {
    w.swup.hooks.on("page:view", renderMermaid);
  }
  document.addEventListener("swup:page:view", renderMermaid);
</script>

<style is:global>
  /* åŸºç¡€å®¹å™¨ */
  .mermaid-container {
    width: 100%;
    margin: 2rem 0;
    position: relative;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    background: #f8fafc;
  }

  :global(.dark) .mermaid-container {
    border-color: #374151;
    background: #1f2937;
  }

  /* âœ… ä¸»ç•Œé¢æ»šåŠ¨å®¹å™¨ï¼šæ¨ªå‘æ»šåŠ¨æ¡ */
  .mermaid-interactive-wrapper {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    position: relative;
    border-radius: 4px;
    background: white;
    scrollbar-width: thin;
  }

  :global(.dark) .mermaid-interactive-wrapper {
    background: #111827;
  }

  /* âœ… å†…å®¹å®¹å™¨å¿…é¡»ç”±å†…å®¹æ’‘å¼€ï¼Œå¦åˆ™ä¸ä¼šæº¢å‡º -> æ²¡æ»šåŠ¨æ¡ */
  .mermaid-interactive-content {
    display: inline-block;
    width: max-content;
    height: auto;
  }

  .mermaid-interactive-content svg {
    display: block;
    max-width: none !important;
    height: auto;
  }

  /* âœ… ä¸»ç•Œé¢å­—ä½“å¼ºåˆ¶ï¼ˆMermaid ä¸åŒå›¾ç±»å‹éƒ½èƒ½è¦†ç›–åˆ°ï¼‰ */
  .mermaid-interactive-content svg text,
  .mermaid-interactive-content svg .nodeLabel,
  .mermaid-interactive-content svg .edgeLabel,
  .mermaid-interactive-content svg .label,
  .mermaid-interactive-content svg tspan {
    font-size: clamp(10px, 1em, 14px) !important;
    font-family: Arial, sans-serif !important;
  }

  /* æç¤ºæ–‡å­— */
  .mermaid-hint {
    text-align: center;
    font-size: 0.875rem;
    color: #64748b;
    margin-top: 1rem;
    padding: 0.5rem;
    background: #f1f5f9;
    border-radius: 4px;
  }

  .mermaid-hint strong {
    color: #475569;
    font-weight: 600;
  }

  :global(.dark) .mermaid-hint {
    color: #94a3b8;
    background: #334155;
  }

  :global(.dark) .mermaid-hint strong {
    color: #cbd5e1;
  }

  /* æ¨¡æ€æ¡† */
  .mermaid-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .mermaid-modal.active {
    display: flex;
  }

  .mermaid-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(4px);
  }

  .mermaid-modal-content {
    position: relative;
    width: 95vw;
    height: 95vh;
    background: white;
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 1;
  }

  :global(.dark) .mermaid-modal-content {
    background: #1f2937;
  }

  /* å…³é—­æŒ‰é’® */
  .mermaid-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* æ§åˆ¶é¢æ¿ */
  .mermaid-modal-controls {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    padding: 0.75rem 1.5rem;
    border-radius: 100px;
    z-index: 10;
    backdrop-filter: blur(8px);
  }

  .mermaid-zoom-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1rem;
    cursor: pointer;
  }

  .mermaid-zoom-level {
    color: white;
    font-size: 0.875rem;
    font-weight: 600;
    min-width: 50px;
    text-align: center;
    margin: 0 0.5rem;
  }

  .mermaid-modal-body {
    flex: 1;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  /* âœ… æ¨¡æ€æ¡†å­—ä½“ä¹Ÿ clamp(10~14) */
  .mermaid-modal-body svg text,
  .mermaid-modal-body svg .nodeLabel,
  .mermaid-modal-body svg .edgeLabel,
  .mermaid-modal-body svg .label,
  .mermaid-modal-body svg tspan {
    font-size: clamp(10px, 1em, 14px) !important;
    font-family: Arial, sans-serif !important;
  }

  /* å“åº”å¼ */
  @media (max-width: 768px) {
    .mermaid-modal-content {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }

    .mermaid-modal-controls {
      bottom: 1rem;
      padding: 0.5rem 1rem;
    }

    .mermaid-zoom-btn {
      width: 32px;
      height: 32px;
      font-size: 0.875rem;
    }

    .mermaid-hint {
      font-size: 0.75rem;
    }
  }
</style>
